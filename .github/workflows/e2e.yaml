name: E2E Tests

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Load TUN module
        run: |
          sudo modprobe tun
          ls -la /dev/net/tun

      - name: Run E2E tests
        working-directory: e2e
        run: ./test.sh

      - name: Show logs on failure
        if: failure()
        working-directory: e2e
        run: |
          echo "=== Coordinator logs ==="
          docker logs coordinator 2>&1 | tail -100 || true
          echo "=== Keycloak logs ==="
          docker logs keycloak 2>&1 | tail -50 || true
          echo "=== Worker 1 logs ==="
          docker logs worker-1 2>&1 | tail -50 || true
          echo "=== Worker 2 logs ==="
          docker logs worker-2 2>&1 | tail -50 || true
          echo "=== Worker 3 logs ==="
          docker logs worker-3 2>&1 | tail -50 || true

  e2e-isolation:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Load TUN module
        run: |
          sudo modprobe tun
          ls -la /dev/net/tun

      - name: Run E2E isolation tests
        working-directory: e2e
        run: ./test-isolation.sh

      - name: Show logs on failure
        if: failure()
        working-directory: e2e
        run: |
          echo "=== Coordinator logs ==="
          docker logs coordinator 2>&1 | tail -100 || true
          echo "=== Keycloak logs ==="
          docker logs keycloak 2>&1 | tail -50 || true
          echo "=== Worker 1 logs ==="
          docker logs worker-1 2>&1 | tail -50 || true
          echo "=== Worker 2 logs ==="
          docker logs worker-2 2>&1 | tail -50 || true
          echo "=== Worker 3 logs ==="
          docker logs worker-3 2>&1 | tail -50 || true
          echo "=== Worker 4 logs ==="
          docker logs worker-4 2>&1 | tail -50 || true
          echo "=== Worker 5 logs ==="
          docker logs worker-5 2>&1 | tail -50 || true
