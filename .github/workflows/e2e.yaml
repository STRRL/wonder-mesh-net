name: E2E Tests

on:
  push:
    branches: [main, manual-mvp]
  pull_request:
    branches: [main]

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Load TUN module
        run: |
          sudo modprobe tun
          ls -la /dev/net/tun

      - name: Run E2E tests
        working-directory: e2e
        run: ./test.sh

      - name: Show logs on failure
        if: failure()
        working-directory: e2e
        run: |
          echo "=== Coordinator logs ==="
          docker logs coordinator 2>&1 | tail -100 || true
          echo "=== Keycloak logs ==="
          docker logs keycloak 2>&1 | tail -50 || true
          echo "=== Worker 1 logs ==="
          docker logs worker-1 2>&1 | tail -50 || true
          echo "=== Worker 2 logs ==="
          docker logs worker-2 2>&1 | tail -50 || true
          echo "=== Worker 3 logs ==="
          docker logs worker-3 2>&1 | tail -50 || true
