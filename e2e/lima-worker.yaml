# Lima VM configuration for Wonder Mesh Net E2E worker nodes
# This VM will run Tailscale client and connect to the embedded Headscale

# Arch: aarch64 for Apple Silicon, x86_64 for Intel
arch: "aarch64"

images:
  - location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-arm64.img"
    arch: "aarch64"
  - location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-amd64.img"
    arch: "x86_64"

cpus: 2
memory: "2GiB"
disk: "10GiB"

# Mount the parent directory to access build artifacts
mounts:
  - location: "~"
    writable: false
  - location: "/tmp/lima"
    writable: true

# Network configuration - use user-v2 for no-root networking
networks:
  - lima: user-v2

# Provision script to install Tailscale and dependencies
provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail

      # Update package list
      export DEBIAN_FRONTEND=noninteractive
      apt-get update

      # Install curl and other dependencies
      apt-get install -y curl iptables iproute2 ca-certificates

      # Install Tailscale 1.78.3 (compatible with Headscale 0.27.1, minimum v1.64.0)
      curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
      curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
      apt-get update
      apt-get install -y tailscale

      # Ensure tailscaled is stopped (we'll start it manually in tests)
      systemctl stop tailscaled || true
      systemctl disable tailscaled || true

      echo "Provisioning complete"

  - mode: user
    script: |
      #!/bin/bash
      set -eux -o pipefail
      echo "User provisioning complete"

# Ensure we can access host services
hostResolver:
  enabled: true
  hosts:
    # Host's localhost will be accessible as host.lima.internal
    host.lima.internal: host.lima.internal
